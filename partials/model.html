<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.36">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>Model 模型 | Laravel 学习记录</title><meta name="description" content="Laravel学习点滴">
    <link rel="modulepreload" href="/laravel-study/assets/app.186c92d2.js"><link rel="modulepreload" href="/laravel-study/assets/model.html.1b0067be.js"><link rel="modulepreload" href="/laravel-study/assets/model.html.6573abc6.js"><link rel="modulepreload" href="/laravel-study/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/laravel-study/assets/style.bd4919f8.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/laravel-study/" class=""><img class="logo" src="/laravel-study/images/laravel-logo.min.svg" alt="Laravel 学习记录"><span class="site-name can-hide">Laravel 学习记录</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/laravel-study/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="基础"><span class="title">基础</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="基础"><span class="title">基础</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/laravel-study/collections/" class="" aria-label="Collection 集合"><!--[--><!--]--> Collection 集合 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/laravel-study/model/" class="" aria-label="Eloquent 模型"><!--[--><!--]--> Eloquent 模型 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="其它"><span class="title">其它</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="其它"><span class="title">其它</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/laravel-study/partials/" class="router-link-active" aria-label="代码片段"><!--[--><!--]--> 代码片段 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/laravel-study/tests/" class="" aria-label="测试"><!--[--><!--]--> 测试 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/laravel-study/tips/" class="" aria-label="Tips"><!--[--><!--]--> Tips <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/laravel-study/others/" class="" aria-label="其它"><!--[--><!--]--> 其它 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="更多"><span class="title">更多</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="更多"><span class="title">更多</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://curder.github.io/blog/" rel="noopener noreferrer" target="_blank" aria-label="Bolg"><!--[--><!--]--> Bolg <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://curder.github.io/what-is-new-in-php/" rel="noopener noreferrer" target="_blank" aria-label="What is new in PHP"><!--[--><!--]--> What is new in PHP <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://curder.github.io/setup-mac-for-developer/" rel="noopener noreferrer" target="_blank" aria-label="Setup mac for developer"><!--[--><!--]--> Setup mac for developer <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/laravel-study/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="基础"><span class="title">基础</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="基础"><span class="title">基础</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/laravel-study/collections/" class="" aria-label="Collection 集合"><!--[--><!--]--> Collection 集合 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/laravel-study/model/" class="" aria-label="Eloquent 模型"><!--[--><!--]--> Eloquent 模型 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="其它"><span class="title">其它</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="其它"><span class="title">其它</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/laravel-study/partials/" class="router-link-active" aria-label="代码片段"><!--[--><!--]--> 代码片段 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/laravel-study/tests/" class="" aria-label="测试"><!--[--><!--]--> 测试 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/laravel-study/tips/" class="" aria-label="Tips"><!--[--><!--]--> Tips <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/laravel-study/others/" class="" aria-label="其它"><!--[--><!--]--> 其它 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="更多"><span class="title">更多</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="更多"><span class="title">更多</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://curder.github.io/blog/" rel="noopener noreferrer" target="_blank" aria-label="Bolg"><!--[--><!--]--> Bolg <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://curder.github.io/what-is-new-in-php/" rel="noopener noreferrer" target="_blank" aria-label="What is new in PHP"><!--[--><!--]--> What is new in PHP <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://curder.github.io/setup-mac-for-developer/" rel="noopener noreferrer" target="_blank" aria-label="Setup mac for developer"><!--[--><!--]--> Setup mac for developer <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">代码片段 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/laravel-study/partials/blade.html" class="sidebar-item" aria-label="Blade 模版"><!--[--><!--]--> Blade 模版 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="Model 模型"><!--[--><!--]--> Model 模型 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/laravel-study/partials/model.html#判断对象是否新增-wasrecentlycreated" class="router-link-active router-link-exact-active sidebar-item" aria-label="判断对象是否新增 wasRecentlyCreated"><!--[--><!--]--> 判断对象是否新增 wasRecentlyCreated <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#重用或克隆查询" class="router-link-active router-link-exact-active sidebar-item" aria-label="重用或克隆查询"><!--[--><!--]--> 重用或克隆查询 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#模型的时间查询方法" class="router-link-active router-link-exact-active sidebar-item" aria-label="模型的时间查询方法"><!--[--><!--]--> 模型的时间查询方法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#增减某个字段" class="router-link-active router-link-exact-active sidebar-item" aria-label="增减某个字段"><!--[--><!--]--> 增减某个字段 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#表不存在时间字段" class="router-link-active router-link-exact-active sidebar-item" aria-label="表不存在时间字段"><!--[--><!--]--> 表不存在时间字段 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#软删除-多次还原" class="router-link-active router-link-exact-active sidebar-item" aria-label="软删除：多次还原"><!--[--><!--]--> 软删除：多次还原 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#all-方法值定返回字段" class="router-link-active router-link-exact-active sidebar-item" aria-label="all 方法值定返回字段"><!--[--><!--]--> all 方法值定返回字段 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#是否返回失败还是模型实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="是否返回失败还是模型实例"><!--[--><!--]--> 是否返回失败还是模型实例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#findorfail-方法还接受主键数组" class="router-link-active router-link-exact-active sidebar-item" aria-label="findOrFail() 方法还接受主键数组"><!--[--><!--]--> findOrFail() 方法还接受主键数组 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#修改数据库字段" class="router-link-active router-link-exact-active sidebar-item" aria-label="修改数据库字段"><!--[--><!--]--> 修改数据库字段 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#查询结果集使用map回调" class="router-link-active router-link-exact-active sidebar-item" aria-label="查询结果集使用map回调"><!--[--><!--]--> 查询结果集使用map回调 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#修改默认的时间字段" class="router-link-active router-link-exact-active sidebar-item" aria-label="修改默认的时间字段"><!--[--><!--]--> 修改默认的时间字段 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#通过某个字段快速排序" class="router-link-active router-link-exact-active sidebar-item" aria-label="通过某个字段快速排序"><!--[--><!--]--> 通过某个字段快速排序 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#数据库原始查询计算运行得更快" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据库原始查询计算运行得更快"><!--[--><!--]--> 数据库原始查询计算运行得更快 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#多个-scope-查询" class="router-link-active router-link-exact-active sidebar-item" aria-label="多个 scope 查询"><!--[--><!--]--> 多个 scope 查询 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#无需转换-carbon" class="router-link-active router-link-exact-active sidebar-item" aria-label="无需转换 carbon"><!--[--><!--]--> 无需转换 carbon <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#按首字母分组" class="router-link-active router-link-exact-active sidebar-item" aria-label="按首字母分组"><!--[--><!--]--> 按首字母分组 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#字段仅更新一次" class="router-link-active router-link-exact-active sidebar-item" aria-label="字段仅更新一次"><!--[--><!--]--> 字段仅更新一次 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#find-方法针对主键查询更多" class="router-link-active router-link-exact-active sidebar-item" aria-label="find 方法针对主键查询更多"><!--[--><!--]--> find 方法针对主键查询更多 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#使用uuid代替主键自增" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用UUID代替主键自增"><!--[--><!--]--> 使用UUID代替主键自增 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#子查询" class="router-link-active router-link-exact-active sidebar-item" aria-label="子查询"><!--[--><!--]--> 子查询 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#隐藏一些字段" class="router-link-active router-link-exact-active sidebar-item" aria-label="隐藏一些字段"><!--[--><!--]--> 隐藏一些字段 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#捕捉数据库错误" class="router-link-active router-link-exact-active sidebar-item" aria-label="捕捉数据库错误"><!--[--><!--]--> 捕捉数据库错误 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#查询生成-软删除" class="router-link-active router-link-exact-active sidebar-item" aria-label="查询生成 - 软删除"><!--[--><!--]--> 查询生成 - 软删除 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#sql-查询" class="router-link-active router-link-exact-active sidebar-item" aria-label="SQL 查询"><!--[--><!--]--> SQL 查询 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#使用db事务" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用DB事务"><!--[--><!--]--> 使用DB事务 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#更新或创建" class="router-link-active router-link-exact-active sidebar-item" aria-label="更新或创建"><!--[--><!--]--> 更新或创建 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#更改日期格式" class="router-link-active router-link-exact-active sidebar-item" aria-label="更改日期格式"><!--[--><!--]--> 更改日期格式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#在json字段中存储数组" class="router-link-active router-link-exact-active sidebar-item" aria-label="在JSON字段中存储数组"><!--[--><!--]--> 在JSON字段中存储数组 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#模型的副本" class="router-link-active router-link-exact-active sidebar-item" aria-label="模型的副本"><!--[--><!--]--> 模型的副本 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#删除模型之前执行任何额外步骤" class="router-link-active router-link-exact-active sidebar-item" aria-label="删除模型之前执行任何额外步骤"><!--[--><!--]--> 删除模型之前执行任何额外步骤 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#将数据持久化到数据库时自动填充列" class="router-link-active router-link-exact-active sidebar-item" aria-label="将数据持久化到数据库时自动填充列"><!--[--><!--]--> 将数据持久化到数据库时自动填充列 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#分析查询" class="router-link-active router-link-exact-active sidebar-item" aria-label="分析查询"><!--[--><!--]--> 分析查询 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#dontexist-方法" class="router-link-active router-link-exact-active sidebar-item" aria-label="dontExist() 方法"><!--[--><!--]--> dontExist() 方法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#添加模型的trait且自动调用它们的-boot-方法" class="router-link-active router-link-exact-active sidebar-item" aria-label="添加模型的Trait且自动调用它们的 boot() 方法"><!--[--><!--]--> 添加模型的Trait且自动调用它们的 boot() 方法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#如何防止-非对象属性-错误" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何防止“非对象属性”错误"><!--[--><!--]--> 如何防止“非对象属性”错误 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#修改模型记录后获取原始属性-getoriginal" class="router-link-active router-link-exact-active sidebar-item" aria-label="修改模型记录后获取原始属性 getOriginal()"><!--[--><!--]--> 修改模型记录后获取原始属性 getOriginal() <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#填充数据库的简单方法" class="router-link-active router-link-exact-active sidebar-item" aria-label="填充数据库的简单方法"><!--[--><!--]--> 填充数据库的简单方法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#按中间表字段排序" class="router-link-active router-link-exact-active sidebar-item" aria-label="按中间表字段排序"><!--[--><!--]--> 按中间表字段排序 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#查找单个记录" class="router-link-active router-link-exact-active sidebar-item" aria-label="查找单个记录"><!--[--><!--]--> 查找单个记录 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#chuckmap-处理结果" class="router-link-active router-link-exact-active sidebar-item" aria-label="chuckMap 处理结果"><!--[--><!--]--> chuckMap 处理结果 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#更新模型但不触发事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="更新模型但不触发事件"><!--[--><!--]--> 更新模型但不触发事件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#定期清理过时记录中的模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="定期清理过时记录中的模型"><!--[--><!--]--> 定期清理过时记录中的模型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#不可变的日期" class="router-link-active router-link-exact-active sidebar-item" aria-label="不可变的日期"><!--[--><!--]--> 不可变的日期 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#withaggregate-方法" class="router-link-active router-link-exact-active sidebar-item" aria-label="withAggregate 方法"><!--[--><!--]--> withAggregate 方法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#upsert-方法插入或更新多条记录" class="router-link-active router-link-exact-active sidebar-item" aria-label="upsert() 方法插入或更新多条记录"><!--[--><!--]--> upsert() 方法插入或更新多条记录 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#过滤结果后检索查询生成器" class="router-link-active router-link-exact-active sidebar-item" aria-label="过滤结果后检索查询生成器"><!--[--><!--]--> 过滤结果后检索查询生成器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#自定有数据转换" class="router-link-active router-link-exact-active sidebar-item" aria-label="自定有数据转换"><!--[--><!--]--> 自定有数据转换 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#根据相关模型的平均值或计数排序" class="router-link-active router-link-exact-active sidebar-item" aria-label="根据相关模型的平均值或计数排序"><!--[--><!--]--> 根据相关模型的平均值或计数排序 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#返回事务结果" class="router-link-active router-link-exact-active sidebar-item" aria-label="返回事务结果"><!--[--><!--]--> 返回事务结果 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#查询中删除-globalscopes" class="router-link-active router-link-exact-active sidebar-item" aria-label="查询中删除 globalScopes()"><!--[--><!--]--> 查询中删除 globalScopes() <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#按-json-字段值排序-mysql" class="router-link-active router-link-exact-active sidebar-item" aria-label="按 JSON 字段值排序（MySQL）"><!--[--><!--]--> 按 JSON 字段值排序（MySQL） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#从第一个结果中获取单列的值-value" class="router-link-active router-link-exact-active sidebar-item" aria-label="从第一个结果中获取单列的值 value()"><!--[--><!--]--> 从第一个结果中获取单列的值 value() <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#检查更改的值是否更改" class="router-link-active router-link-exact-active sidebar-item" aria-label="检查更改的值是否更改"><!--[--><!--]--> 检查更改的值是否更改 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#定义访问器和修改器的新方法" class="router-link-active router-link-exact-active sidebar-item" aria-label="定义访问器和修改器的新方法"><!--[--><!--]--> 定义访问器和修改器的新方法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#保存模型及其所有关系" class="router-link-active router-link-exact-active sidebar-item" aria-label="保存模型及其所有关系"><!--[--><!--]--> 保存模型及其所有关系 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#获取查询日志" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取查询日志"><!--[--><!--]--> 获取查询日志 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/laravel-study/partials/model.html#wherebelongsto-关联查询" class="router-link-active router-link-exact-active sidebar-item" aria-label="whereBelongsTo 关联查询"><!--[--><!--]--> whereBelongsTo 关联查询 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/laravel-study/partials/routing.html" class="sidebar-item" aria-label="Routing 路由"><!--[--><!--]--> Routing 路由 <!--[--><!--]--></a><!----></li><li><a href="/laravel-study/partials/testing.html" class="sidebar-item" aria-label="Testing 测试"><!--[--><!--]--> Testing 测试 <!--[--><!--]--></a><!----></li><li><a href="/laravel-study/partials/urls.html" class="sidebar-item" aria-label="URL 生成"><!--[--><!--]--> URL 生成 <!--[--><!--]--></a><!----></li><li><a href="/laravel-study/partials/validation.html" class="sidebar-item" aria-label="Validation 验证"><!--[--><!--]--> Validation 验证 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="model-模型" tabindex="-1"><a class="header-anchor" href="#model-模型" aria-hidden="true">#</a> Model 模型</h1><h2 id="判断对象是否新增-wasrecentlycreated" tabindex="-1"><a class="header-anchor" href="#判断对象是否新增-wasrecentlycreated" aria-hidden="true">#</a> 判断对象是否新增 <code>wasRecentlyCreated</code></h2><p>在 Laravel 中，有时可能需要检查模型是从数据库中获取的还是刚刚在当前请求生命周期中创建的——比如使用 <code>firstOrCreate()</code> 时。</p><p>为此，您可以在模型上使用 <code>-&gt;wasRecentlyCreated</code> 字段。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">createOrUpdate</span><span class="token punctuation">(</span>
<span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;email&#39;</span> <span class="token operator">=&gt;</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;email&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span> <span class="token operator">=&gt;</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">wasRecentlyCreated</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用户新增逻辑代码</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用户已存在并从数据库中获取</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="重用或克隆查询" tabindex="-1"><a class="header-anchor" href="#重用或克隆查询" aria-hidden="true">#</a> 重用或克隆查询</h2><p>通常，需要从过滤后的查询再进行多次查询。大多数时候使用 <code>query()</code> 方法，编写一个查询来获取创建的活跃和非活跃产品。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$query</span> <span class="token operator">=</span> <span class="token class-name static-context">Product</span><span class="token operator">::</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$today</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token property">q_date</span> <span class="token operator">??</span> <span class="token function">today</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$today</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token variable">$today</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$active_products</span> <span class="token operator">=</span> <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;status&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不会修改 $query 变量</span>
<span class="token variable">$inactive_products</span> <span class="token operator">=</span> <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;status&#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从 $query 中获取正确的产品</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="模型的时间查询方法" tabindex="-1"><a class="header-anchor" href="#模型的时间查询方法" aria-hidden="true">#</a> 模型的时间查询方法</h2><p>Laravel 提供了一些时间查询方法，例如：<code>whereDate</code>、<code>whereMonth</code>、<code>whereDay</code>、<code>whereYear</code>、<code>whereTime</code>。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$products</span> <span class="token operator">=</span> <span class="token class-name static-context">Product</span><span class="token operator">::</span><span class="token function">whereDate</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;2018-01-31&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$products</span> <span class="token operator">=</span> <span class="token class-name static-context">Product</span><span class="token operator">::</span><span class="token function">whereMonth</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;12&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$products</span> <span class="token operator">=</span> <span class="token class-name static-context">Product</span><span class="token operator">::</span><span class="token function">whereDay</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;31&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$products</span> <span class="token operator">=</span> <span class="token class-name static-context">Product</span><span class="token operator">::</span><span class="token function">whereYear</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;Y&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$products</span> <span class="token operator">=</span> <span class="token class-name static-context">Product</span><span class="token operator">::</span><span class="token function">whereTime</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;=&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;14:13:58&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="增减某个字段" tabindex="-1"><a class="header-anchor" href="#增减某个字段" aria-hidden="true">#</a> 增减某个字段</h2><p>如果想在某个表中增加某列的数值，只需使用 <code>increment()</code> 函数。 当然不仅可以增加 <code>1</code>，也可以增加一些数字，比如 <code>50</code>。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Post</span><span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;view_count&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token variable">$user_id</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;points&#39;</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># 减少字段 points 的值</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="表不存在时间字段" tabindex="-1"><a class="header-anchor" href="#表不存在时间字段" aria-hidden="true">#</a> 表不存在时间字段</h2><p>如果数据库表不包含时间戳字段 <code>created_at</code> 和 <code>updated_at</code>，可以通过 <code>$timestamps = false</code> 属性指定模型不使用它们。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name-definition class-name">Company</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$timestamps</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="软删除-多次还原" tabindex="-1"><a class="header-anchor" href="#软删除-多次还原" aria-hidden="true">#</a> 软删除：多次还原</h2><p>使用软删除时，使用 <code>restore()</code> 恢复多行。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Post</span><span class="token operator">::</span><span class="token function">onlyTrashed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;author_id&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="all-方法值定返回字段" tabindex="-1"><a class="header-anchor" href="#all-方法值定返回字段" aria-hidden="true">#</a> <code>all</code> 方法值定返回字段</h2><p>调用模型的 <code>Model::all()</code> 时，可以指定要返回的列。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;email&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="是否返回失败还是模型实例" tabindex="-1"><a class="header-anchor" href="#是否返回失败还是模型实例" aria-hidden="true">#</a> 是否返回失败还是模型实例</h2><p>除了 <code>findOrFail()</code>，还有模型方法 <code>firstOrFail()</code>，如果没有找到查询记录，会返回 404 。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;email&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;test@exmple.com&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">firstOrFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 可以调用 `firstOr()` 对失败执行其他操作</span>
<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;email&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;test@example.com&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">firstOr</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="findorfail-方法还接受主键数组" tabindex="-1"><a class="header-anchor" href="#findorfail-方法还接受主键数组" aria-hidden="true">#</a> <code>findOrFail()</code> 方法还接受主键数组</h2><p><code>findOrFail()</code> 方法接受主键数组。如果未找到任何这些 id，则它“失败”。</p><p>如果需要检索一组特定的模型并且不想检查您获得的计数是否是您预期的计数。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检索用户</span>

<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 因为用户不存在而抛出 404</span>

<span class="token variable">$users</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检索三个用户</span>

<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出因为它无法找到 *all* 的用户</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="修改数据库字段" tabindex="-1"><a class="header-anchor" href="#修改数据库字段" aria-hidden="true">#</a> 修改数据库字段</h2><p>在查询语句中，可以指定 <code>as</code> 以返回具有不同名称的任何列，就像在普通 SQL 查询中一样。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;users&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;email as user_email&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="查询结果集使用map回调" tabindex="-1"><a class="header-anchor" href="#查询结果集使用map回调" aria-hidden="true">#</a> 查询结果集使用map回调</h2><p>在模型查询后，可以使用 <code>Collections</code> 中的 <code>map()</code> 函数来修改行。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;role_id&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name type-declaration">User</span> <span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">some_column</span> <span class="token operator">=</span> <span class="token function">some_function</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="修改默认的时间字段" tabindex="-1"><a class="header-anchor" href="#修改默认的时间字段" aria-hidden="true">#</a> 修改默认的时间字段</h2><p>如果使用的是非 Laravel 数据库并且时间戳列的名称不同怎么办？ 比如 <code>create_time</code> 和 <code>update_time</code>。 可以在模型中指定它们：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">CREATED_AT</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;create_time&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">UPDATED_AT</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;update_time&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="通过某个字段快速排序" tabindex="-1"><a class="header-anchor" href="#通过某个字段快速排序" aria-hidden="true">#</a> 通过某个字段快速排序</h2><p>通过使用 <code>latest()</code> 和 <code>oldest()</code> 代替 <code>-&gt;orderBy()</code>。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 降序排序，代替 -&gt;orderBy(&#39;created_at&#39;, &#39;desc&#39;)</span>
<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">oldest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 升序排序</span>
<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;updated_at&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定字段，降序排序</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="数据库原始查询计算运行得更快" tabindex="-1"><a class="header-anchor" href="#数据库原始查询计算运行得更快" aria-hidden="true">#</a> 数据库原始查询计算运行得更快</h2><p>使用 SQL 原始查询，如 <code>whereRaw()</code> 方法，直接在查询中进行一些特定于 <code>DB</code> 的计算，而不是在 <code>Laravel</code> 中，通常结果会更快。</p><p>例如，如果想获得注册后 30 天以上仍处于活跃状态的用户，代码如下：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;active&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">whereRaw</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;TIMESTAMPDIFF(DAY, created_at, updated_at) &gt; ?&#39;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="多个-scope-查询" tabindex="-1"><a class="header-anchor" href="#多个-scope-查询" aria-hidden="true">#</a> 多个 scope 查询</h2><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 模型定义</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">scopeActive</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;active&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">scopeRegisteredWithinDays</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">,</span> <span class="token variable">$days</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;&gt;=&#39;</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">subDays</span><span class="token punctuation">(</span><span class="token variable">$days</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用 </span>
<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">registeredWithinDays</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="无需转换-carbon" tabindex="-1"><a class="header-anchor" href="#无需转换-carbon" aria-hidden="true">#</a> 无需转换 carbon</h2><p>如果正在执行 <code>whereDate()</code> 并检索今天的记录，可以使用 Carbon 的 <code>now()</code> ，它会自动转换为日期。 无需执行 <code>-&gt;toDateString()</code>。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 无需对时间进行转换，直接使用 `now()`</span>
<span class="token variable">$todayUsers</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">whereDate</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="按首字母分组" tabindex="-1"><a class="header-anchor" href="#按首字母分组" aria-hidden="true">#</a> 按首字母分组</h2><p>可以按任何自定义条件对 Eloquent 结果进行分组。</p><p>以下是按用户名的首字母分组的方法：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$item</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="字段仅更新一次" tabindex="-1"><a class="header-anchor" href="#字段仅更新一次" aria-hidden="true">#</a> 字段仅更新一次</h2><p>如果有 DB 列，只想设置一次并且不再更新，可以使用 mutator 对 Eloquent 模型设置该限制：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setEmailAttribute</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">email</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">attributes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;email&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="find-方法针对主键查询更多" tabindex="-1"><a class="header-anchor" href="#find-方法针对主键查询更多" aria-hidden="true">#</a> find 方法针对主键查询更多</h2><p>模型方法 <code>find()</code> 可以接受多个数组参数，然后它返回一个包含所有找到的记录的集合，而不仅仅是一个模型实例：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回模型实例</span>
<span class="token variable">$users</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回模型集合</span>

<span class="token variable">$users</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;first_name&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;email&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定返回的模型集合中的对应字段</span>

<span class="token comment">// 通过模型主键查询可以通过 `-&gt;whereKey()` 方法</span>
<span class="token variable">$users</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">whereKey</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="使用uuid代替主键自增" tabindex="-1"><a class="header-anchor" href="#使用uuid代替主键自增" aria-hidden="true">#</a> 使用UUID代替主键自增</h2><p>在模型中不希望使用主键自增？可以使用UUID代替：</p><ul><li>迁移文件</li></ul><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Schema</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;users&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name type-declaration">Blueprint</span> <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// $table-&gt;increments(&#39;id&#39;);</span>
    <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">unique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>模型定义</li></ul><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$incrementing</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$keyType</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;string&#39;</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">creating</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">attributes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;id&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name static-context">Str</span><span class="token operator">::</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="子查询" tabindex="-1"><a class="header-anchor" href="#子查询" aria-hidden="true">#</a> 子查询</h2><p>从 Laravel 6 开始，可以在模型语句中使用 <code>addSelect()</code>，并对添加的列进行一些计算。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">return</span> <span class="token class-name static-context">Destination</span><span class="token operator">::</span><span class="token function">addSelect</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;last_flight&#39;</span> <span class="token operator">=&gt;</span> <span class="token class-name static-context">Flight</span><span class="token operator">::</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">whereColumn</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;destination_id&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;destinations.id&#39;</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;arrived_at&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;desc&#39;</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="隐藏一些字段" tabindex="-1"><a class="header-anchor" href="#隐藏一些字段" aria-hidden="true">#</a> 隐藏一些字段</h2><p>在进行模型查询时，如果要隐藏特定字段不被返回，最快的方法之一是在 Collection 结果上添加 <code>-&gt;makeHidden()</code>。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$users</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">makeHidden</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;email_verified_at&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;deleted_at&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 或者在模型中定义</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Authenticatable</span> 
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">protected</span> <span class="token variable">$hidden</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;email_verified_at&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;deleted_at&#39;</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="捕捉数据库错误" tabindex="-1"><a class="header-anchor" href="#捕捉数据库错误" aria-hidden="true">#</a> 捕捉数据库错误</h2><p>如果要捕获模型查询异常，请使用特定的 <code>QueryException</code> 而不是默认的 <code>Exception</code> 类，将能够获得错误的确切 SQL 代码。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// Some Eloquent/SQL statement</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>QueryException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$e</span><span class="token operator">-&gt;</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">&#39;23000&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// integrity constraint violation</span>
        <span class="token keyword">return</span> <span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">withError</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;Invalid data&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="查询生成-软删除" tabindex="-1"><a class="header-anchor" href="#查询生成-软删除" aria-hidden="true">#</a> 查询生成 - 软删除</h2><p>不要忘记，当使用模型时，软删除会排除条目，但如果您使用 Query Builder，则不会起作用。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$users</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将不包含已删除的项</span>
<span class="token variable">$users</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">withTrashed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 包含已删除的项</span>

<span class="token variable">$users</span> <span class="token operator">=</span> <span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;users&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 包含已删除的项</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="sql-查询" tabindex="-1"><a class="header-anchor" href="#sql-查询" aria-hidden="true">#</a> SQL 查询</h2><p>如果需要执行一个简单的 SQL 查询，但没有得到任何结果——比如更改 DB 模式中的某些内容，可以执行 <code>DB::statement()</code>。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">statement</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;DROP TABLE users&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">statement</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;ALTER TABLE projects AUTO_INCREMENT=123&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="使用db事务" tabindex="-1"><a class="header-anchor" href="#使用db事务" aria-hidden="true">#</a> 使用DB事务</h2><p>如果执行了两个数据库操作，第二个可能会出错，那么应该回滚第一个。 为此，建议使用 DB 事务：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;users&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;votes&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;posts&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="更新或创建" tabindex="-1"><a class="header-anchor" href="#更新或创建" aria-hidden="true">#</a> 更新或创建</h2><p>如果需要检查记录是否存在，存在则更新它，不存在则创建一个新记录。 使用模型的 <code>updateOrCreate()</code> 方法：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$flight</span> <span class="token operator">=</span> <span class="token class-name static-context">Flight</span><span class="token operator">::</span><span class="token function">updateOrCreate</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;departure&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;Oakland&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;destination&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;San Diego&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 条件</span>
    <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;price&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;discounted&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="更改日期格式" tabindex="-1"><a class="header-anchor" href="#更改日期格式" aria-hidden="true">#</a> 更改日期格式</h2><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 模型定义</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getCreatedAtFormattedAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">created_at</span><span class="token operator">-&gt;</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;H:i d, M Y&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getUpdatedAtFormattedAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">updated_at</span><span class="token operator">-&gt;</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;H:i d, M Y&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">created_at_formatted</span><span class="token punctuation">;</span> <span class="token comment">// `12:25 18, Jan 2021`</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="在json字段中存储数组" tabindex="-1"><a class="header-anchor" href="#在json字段中存储数组" aria-hidden="true">#</a> 在JSON字段中存储数组</h2><p>如果输入字段需要一个数组并且必须将其存储为 JSON，可以在模型中使用 <code>$casts</code> 属性。这里的 <code>images</code> 是一个 <code>JSON</code> 属性。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 模型定义</span>
<span class="token keyword">protected</span> <span class="token variable">$casts</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">&#39;images&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;array&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="模型的副本" tabindex="-1"><a class="header-anchor" href="#模型的副本" aria-hidden="true">#</a> 模型的副本</h2><p>如果有两个非常相似的模型（例如送货地址和帐单地址），并且需要将一个复制到另一个，可以使用 <code>replicate()</code> 方法并在此之后更改一些属性。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$shipping</span> <span class="token operator">=</span> <span class="token class-name static-context">Address</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string single-quoted-string">&#39;type&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;shipping&#39;</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;line_1&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;123 Example Street&#39;</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;city&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;Victorville&#39;</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;state&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;CA&#39;</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;postcode&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;90001&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$billing</span> <span class="token operator">=</span> <span class="token variable">$shipping</span><span class="token operator">-&gt;</span><span class="token function">replicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string single-quoted-string">&#39;type&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;billing&#39;</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$billing</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="删除模型之前执行任何额外步骤" tabindex="-1"><a class="header-anchor" href="#删除模型之前执行任何额外步骤" aria-hidden="true">#</a> 删除模型之前执行任何额外步骤</h2><p>可以在重写的删除方法中使用 <code>Model::delete()</code> 来执行额外的步骤。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// App\Models\User.php</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment">// 这里有额外的步骤，无论你想要什么</span>

    <span class="token class-name static-context">Model</span><span class="token operator">::</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 现在执行正常删除</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="将数据持久化到数据库时自动填充列" tabindex="-1"><a class="header-anchor" href="#将数据持久化到数据库时自动填充列" aria-hidden="true">#</a> 将数据持久化到数据库时自动填充列</h2><p>如果将数据持久化到数据库时自动填充一列（例如：<code>slug</code>），请使用模型监听者而不是每次都对其进行硬编码。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Str</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Article</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">parent</span><span class="token punctuation">:</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword static-context">static</span><span class="token operator">::</span><span class="token function">saving</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token property">slug</span> <span class="token operator">=</span> <span class="token class-name static-context">Str</span><span class="token operator">::</span><span class="token function">slug</span><span class="token punctuation">(</span><span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token property">title</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="分析查询" tabindex="-1"><a class="header-anchor" href="#分析查询" aria-hidden="true">#</a> 分析查询</h2><p>可以在查询上调用 <code>explain()</code> 方法来了解有关查询的额外信息。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Book</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;Ruskin Bond&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">explain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">dd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 像下面这样</span>
Illuminate\Support\Collection <span class="token punctuation">{</span><span class="token comment">#5344</span>
    all<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token comment">#15407</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;id&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;select_type&quot;</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">&quot;SIMPLE&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;table&quot;</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">&quot;books&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;partitions&quot;</span><span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">&quot;ALL&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;possible_keys&quot;</span><span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;key&quot;</span><span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;key_len&quot;</span><span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;ref&quot;</span><span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;rows&quot;</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;filtered&quot;</span><span class="token punctuation">:</span> <span class="token number">11.11111164093</span><span class="token punctuation">,</span>
            <span class="token operator">+</span><span class="token string double-quoted-string">&quot;Extra&quot;</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">&quot;Using where&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="dontexist-方法" tabindex="-1"><a class="header-anchor" href="#dontexist-方法" aria-hidden="true">#</a> <code>dontExist()</code> 方法</h2><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token operator">===</span> <span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;status&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;pending&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// 但是由于我不关心总数，`exists()` 方法更简洁。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;status&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;pending&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// `doesntExist()` 方法使之更加简洁</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$model</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;status&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;pending&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">doesntExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="添加模型的trait且自动调用它们的-boot-方法" tabindex="-1"><a class="header-anchor" href="#添加模型的trait且自动调用它们的-boot-方法" aria-hidden="true">#</a> 添加模型的Trait且自动调用它们的 <code>boot()</code> 方法</h2><p>如果有一个 Trait 想要添加到几个模型中以自动调用它们的 <code>boot()</code> 方法，可以在 <code>Trait</code> 中编写静态方法 boot[TraitName]。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// Transaction 模型</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Transaction</span> <span class="token keyword">extends</span>  <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">MultiTenantModelTrait</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Task 模型</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Task</span> <span class="token keyword">extends</span>  <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">MultiTenantModelTrait</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// MultiTenantModelTrait Trait</span>
<span class="token keyword">trait</span> <span class="token class-name-definition class-name">MultiTenantModelTrait</span>
<span class="token punctuation">{</span>
    <span class="token comment">// This method&#39;s name is boot[TraitName]</span>
    <span class="token comment">// It will be auto-called as boot() of Transaction/Task</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function-definition function">bootMultiTenantModelTrait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword static-context">static</span><span class="token operator">::</span><span class="token function">creating</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$isAdmin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$isAdmin</span><span class="token operator">-&gt;</span><span class="token property">created_by_id</span> <span class="token operator">=</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="如何防止-非对象属性-错误" tabindex="-1"><a class="header-anchor" href="#如何防止-非对象属性-错误" aria-hidden="true">#</a> 如何防止“非对象属性”错误</h2><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 如果没有作者附加到帖子，这个关系将返回一个空的 `App\Author` 模型</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">author</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">belongsTo</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;App\Author&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">withDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// or</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">author</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">belongsTo</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;App\Author&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">withDefault</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;name&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;Guest Author&#39;</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 代码调用</span>
<span class="token variable">$post</span><span class="token operator">-&gt;</span><span class="token property">author</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="修改模型记录后获取原始属性-getoriginal" tabindex="-1"><a class="header-anchor" href="#修改模型记录后获取原始属性-getoriginal" aria-hidden="true">#</a> 修改模型记录后获取原始属性 <code>getOriginal()</code></h2><p>修改模型记录后获取原始属性，可以通过调用 <code>getOriginal()</code> 获取原始属性。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name class-name-fully-qualified static-context">App<span class="token punctuation">\</span>User</span><span class="token operator">::</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">;</span> <span class="token comment">// John</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;Peter&quot;</span><span class="token punctuation">;</span> <span class="token comment">// Peter</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">getOriginal</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// John</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">getOriginal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Original $user record</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="填充数据库的简单方法" tabindex="-1"><a class="header-anchor" href="#填充数据库的简单方法" aria-hidden="true">#</a> 填充数据库的简单方法</h2><p>使用 .sql 转储文件播种数据库的简单方法。假如存在 <code>dump.sql</code>：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">unprepared</span><span class="token punctuation">(</span>
    <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token constant">__DIR__</span> <span class="token operator">.</span> <span class="token string single-quoted-string">&#39;./dump.sql&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="按中间表字段排序" tabindex="-1"><a class="header-anchor" href="#按中间表字段排序" aria-hidden="true">#</a> 按中间表字段排序</h2><p><code>BelongsToMany::orderByPivot()</code> 允许直接对 BelongsToMany 关系查询的结果进行排序。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name-definition class-name">Tag</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;tags&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Post</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;posts&#39;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span><span class="token class-name static-context">Tag</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;post_tag&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;post_id&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;tag_id&#39;</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">using</span><span class="token punctuation">(</span><span class="token class-name static-context">PostTagPivot</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">withTimestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-&gt;</span><span class="token function">withPivot</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;flag&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">PostTagPivot</span> <span class="token keyword">extends</span> <span class="token class-name">Pivot</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;post_tag&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 调用</span>
<span class="token class-name static-context">Post</span><span class="token operator">::</span><span class="token function">findOrFail</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">tags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">orderByPivot</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;flag&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;desc&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="查找单个记录" tabindex="-1"><a class="header-anchor" href="#查找单个记录" aria-hidden="true">#</a> 查找单个记录</h2><p><code>sole()</code> 方法将只返回一条符合条件的记录。</p><ul><li><p>如果没有找到这样的条目，则会抛出 <code>NoRecordsFoundException</code>。</p></li><li><p>如果找到多条记录，则会抛出 <code>MultipleRecordsFoundException</code>。</p></li></ul><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;products&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;ref&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;#123&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">sole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="chuckmap-处理结果" tabindex="-1"><a class="header-anchor" href="#chuckmap-处理结果" aria-hidden="true">#</a> chuckMap 处理结果</h2><p>类似于 <code>each()</code> 方法，但更易于使用。自动将结果拆分为多个部分（块）。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">return</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">chunkMap</span><span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">&#39;id&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">&#39;name&#39;</span> <span class="token operator">=&gt;</span> <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="更新模型但不触发事件" tabindex="-1"><a class="header-anchor" href="#更新模型但不触发事件" aria-hidden="true">#</a> 更新模型但不触发事件</h2><p>有时需要在不发送任何事件的情况下更新模型。现在可以使用 <code>updateQuietly()</code> 方法来做到这一点，该方法在背后使用 <code>saveQuietly()</code> 方法。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$flight</span><span class="token operator">-&gt;</span><span class="token function">updateQuietly</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;departed&#39;</span> <span class="token operator">=&gt;</span> <span class="token constant boolean">false</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="定期清理过时记录中的模型" tabindex="-1"><a class="header-anchor" href="#定期清理过时记录中的模型" aria-hidden="true">#</a> 定期清理过时记录中的模型</h2><p>有了这个特性，Laravel会自动执行此操作，只需要在 Kernel 类中调整 <code>model:prune</code> 命令的频率即可。</p><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">模型定义</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">定时任务</button></li></ul></div><!--[--><div class="code-group-item" aria-selected="false"><!--[--><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Prunable</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Flight</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">Prunable</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * Get the prunable model query.
     *
     * <span class="token keyword">@return</span> <span class="token class-name"><span class="token punctuation">\</span>Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Builder</span>
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">prunable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword static-context">static</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;created_at&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;&amp;lt;=&#39;</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">subMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 此外，可以设置在删除模型之前必须执行的操作：</span>
    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">pruning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 删除关联资源，例如文件</span>
        <span class="token class-name static-context">Storage</span><span class="token operator">::</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;s3&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// App\Console\Kernel.php</span>
<span class="token doc-comment comment">/**
 * Define the application&#39;s command schedule.
 *
 * <span class="token keyword">@param</span>  <span class="token class-name"><span class="token punctuation">\</span>Illuminate<span class="token punctuation">\</span>Console<span class="token punctuation">\</span>Scheduling<span class="token punctuation">\</span>Schedule</span>  <span class="token parameter">$schedule</span>
 * <span class="token keyword">@return</span> <span class="token class-name"><span class="token keyword">void</span></span>
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">schedule</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Schedule</span> <span class="token variable">$schedule</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$schedule</span><span class="token operator">-&gt;</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;model:prune&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">daily</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// $schedule-&gt;command(&#39;model:prune&#39;, [&#39;--model&#39; =&gt; [Address::class, Flight::class]])-&gt;daily(); // 指定特定模型参数</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><!--]--></div><!--]--></div><h2 id="不可变的日期" tabindex="-1"><a class="header-anchor" href="#不可变的日期" aria-hidden="true">#</a> 不可变的日期</h2><p><code>Laravel 8.53</code> 引入了将日期转换为不可变的 <code>immutable_date</code> 和 <code>immutable_datetime</code> 种姓。</p><p>转换为 <code>CarbonImmutable</code> 而不是常规的 <code>Carbon</code> 实例。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$casts</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;date_field&#39;</span>     <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;immutable_date&#39;</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;datetime_field&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;immutable_datetime&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="withaggregate-方法" tabindex="-1"><a class="header-anchor" href="#withaggregate-方法" aria-hidden="true">#</a> <code>withAggregate</code> 方法</h2><p>在底层，模型中的 <code>withAvg</code>/<code>withCount</code>/<code>withSum</code> 和其他方法使用了 <code>withAggregate</code> 方法。</p><p>可以使用此方法添加基于关系的子选择</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 模型 Post</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Post</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">belongsTo</span><span class="token punctuation">(</span><span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$posts</span> <span class="token operator">=</span> <span class="token class-name static-context">Post</span><span class="token operator">::</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;user&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 惰性加载所有用户</span>

<span class="token variable">$posts</span> <span class="token operator">=</span> <span class="token class-name static-context">Post</span><span class="token operator">::</span><span class="token function">withAggregate</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;user&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可以添加子选择以仅检索用户名</span>

<span class="token variable">$posts</span><span class="token operator">-&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token property">user_name</span><span class="token punctuation">;</span> <span class="token comment">// 将为 Post 实例添加一个 &#39;user_name&#39; 属性</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="upsert-方法插入或更新多条记录" tabindex="-1"><a class="header-anchor" href="#upsert-方法插入或更新多条记录" aria-hidden="true">#</a> <code>upsert()</code> 方法插入或更新多条记录</h2><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Flight</span><span class="token operator">::</span><span class="token function">upsert</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;departure&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;Oakland&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;destination&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;San Diego&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;price&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">99</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;departure&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;Chicago&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;destination&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;New York&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;price&#39;</span> <span class="token operator">=&gt;</span> <span class="token number">150</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;departure&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;destination&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;price&#39;</span><span class="token punctuation">]</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>第一个数组：要插入或更新的值</li><li>第二个数组：select语句中使用的唯一标识符列</li><li>第三个数组：如果记录存在则要更新的列</li></ul><h2 id="过滤结果后检索查询生成器" tabindex="-1"><a class="header-anchor" href="#过滤结果后检索查询生成器" aria-hidden="true">#</a> 过滤结果后检索查询生成器</h2><p>要在过滤结果后检索查询生成器：您可以使用 <code>-&gt;toQuery()</code>。 该方法在内部使用集合的第一个模型和集合模型上的 <code>whereKey</code> 比较。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$loggedInUsers</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;logged_in&#39;</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检索所有已登录的用户</span>

<span class="token variable">$nthUsers</span> <span class="token operator">=</span> <span class="token variable">$loggedInUsers</span><span class="token operator">-&gt;</span><span class="token function">nth</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用 Collection 方法或 php 过滤过滤它们</span>

<span class="token variable">$nthUsers</span><span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不能在集合上执行此操作</span>

<span class="token comment">// 但是可以使用 `-&gt;toQuery()` 检索 Builder</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$nthUsers</span><span class="token operator">-&gt;</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$nthUsers</span><span class="token operator">-&gt;</span><span class="token function">toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="自定有数据转换" tabindex="-1"><a class="header-anchor" href="#自定有数据转换" aria-hidden="true">#</a> 自定有数据转换</h2><p>可以创建自定义转换来自动格式化模型数据。如下检索或更改用户名时将其大写的示例。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name-definition class-name">CapitalizeWordsCast</span> <span class="token keyword">implements</span> <span class="token class-name">CastsAttributes</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">get</span><span class="token punctuation">(</span><span class="token variable">$model</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$attributes</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">ucwords</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">set</span><span class="token punctuation">(</span><span class="token variable">$model</span><span class="token punctuation">,</span> <span class="token keyword type-hint">string</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token keyword type-hint">array</span> <span class="token variable">$attributes</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">ucwords</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$casts</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">&#39;name&#39;</span>  <span class="token operator">=&gt;</span> <span class="token class-name static-context">CapitalizeWordsCast</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">&#39;email&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;string&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="根据相关模型的平均值或计数排序" tabindex="-1"><a class="header-anchor" href="#根据相关模型的平均值或计数排序" aria-hidden="true">#</a> 根据相关模型的平均值或计数排序</h2><p>是否曾经需要根据相关型号的平均值或计数进行排序</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">bestBooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name static-context">Book</span><span class="token operator">::</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">-&gt;</span><span class="token function">withAvg</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;ratings as average_rating&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;rating&#39;</span><span class="token punctuation">)</span>
        <span class="token operator">-&gt;</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;average_rating&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="返回事务结果" tabindex="-1"><a class="header-anchor" href="#返回事务结果" aria-hidden="true">#</a> 返回事务结果</h2><p>如果有一个 DB 事务，想要返回它的结果，至少有两种方式，看例子：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 1. 可以通过引用传递参数</span>
<span class="token variable">$invoice</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$invoice</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$invoice</span> <span class="token operator">=</span> <span class="token class-name static-context">Invoice</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$invoice</span><span class="token operator">-&gt;</span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 2. 或更短：只返回事务结果</span>
<span class="token variable">$invoice</span> <span class="token operator">=</span> <span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$invoice</span> <span class="token operator">=</span> <span class="token class-name static-context">Invoice</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$invoice</span><span class="token operator">-&gt;</span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token variable">$invoice</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="查询中删除-globalscopes" tabindex="-1"><a class="header-anchor" href="#查询中删除-globalscopes" aria-hidden="true">#</a> 查询中删除 <code>globalScopes()</code></h2><p>使用模型全局作用域时，不仅可以使用 MULTIPLE 作用域，还可以在不需要时删除某些scope，方法是将数组提供给 <code>withoutGlobalScopes()</code>：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// 删除所有全局范围</span>
<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">withoutGlobalScopes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除一些全局范围</span>
<span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">withoutGlobalScopes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token class-name static-context">FirstScope</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name static-context">SecondScope</span><span class="token operator">::</span><span class="token keyword">class</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="按-json-字段值排序-mysql" tabindex="-1"><a class="header-anchor" href="#按-json-字段值排序-mysql" aria-hidden="true">#</a> 按 JSON 字段值排序（MySQL）</h2><p>在 Laravel 开发中使用<code>json</code> 类型字段存储多个值，很快就遇到了如何使用 JSON 属性字段对数据进行排序的问题。</p><p>由于 JSON 属性中的数据被转换为字符串数据，因此在 eloquent orderBy 方法中执行 <code>json_field-&gt;property</code> 的常用方法没有给出正确的结果。</p><p>我们可以使用它来排序我们的结果之前，必须将字段属性转换为适当的数据类型，就我而言，我想将其转换为无符号整数。</p><p>Eloquent 模型上的 <code>$casts</code> 属性不适用于 JSON 属性，当前找到的唯一方法是使用 <code>orderByRaw</code>。</p><ul><li>数据排序</li></ul><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Post</span><span class="token operator">::</span><span class="token function">orderByRaw</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;CAST(extra-&gt;&quot;$.popular_order_number&quot; AS unsigned) ASC&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><ul><li>数据查询</li></ul><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token class-name static-context">Post</span><span class="token operator">::</span><span class="token function">whereJsonContains</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;extra-&gt;is_popular&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>参考地址：<a href="https://5balloons.info/sort-by-mysql-json-field-value-in-laravel/" target="_blank" rel="noopener noreferrer">Sort by Mysql JSON Field Value in Laravel<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="从第一个结果中获取单列的值-value" tabindex="-1"><a class="header-anchor" href="#从第一个结果中获取单列的值-value" aria-hidden="true">#</a> 从第一个结果中获取单列的值 <code>value()</code></h2><p>可以使用 <code>value()</code> 方法从查询的第一个结果中获取单个列的值</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// Instead of</span>
<span class="token class-name static-context">Integration</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;foo&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token property">active</span><span class="token punctuation">;</span>

<span class="token comment">// You can use</span>
<span class="token class-name static-context">Integration</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;foo&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;active&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// or this to throw an exception if no records found</span>
<span class="token class-name static-context">Integration</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">&#39;foo&#39;</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">valueOrFail</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;active&#39;</span><span class="token punctuation">)</span>&#39;<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="检查更改的值是否更改" tabindex="-1"><a class="header-anchor" href="#检查更改的值是否更改" aria-hidden="true">#</a> 检查更改的值是否更改</h2><p>想知道对模型所做的更改是否改变了键的值，使用 <code>originalIsEquivalent</code>。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">User</span><span class="token operator">::</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&#39;name&#39; =&gt; &quot;John&#39;]</span>

<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;John&#39;</span><span class="token punctuation">;</span>

<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">originalIsEquivalent</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;David&#39;</span><span class="token punctuation">;</span> <span class="token comment">// Set directly</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;name&#39;</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">&#39;David&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Or set via fill</span>

<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">originalIsEquivalent</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="定义访问器和修改器的新方法" tabindex="-1"><a class="header-anchor" href="#定义访问器和修改器的新方法" aria-hidden="true">#</a> 定义访问器和修改器的新方法</h2><p>在 Laravel 8.77 中定义属性访问器和修改器的新方法：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// Before, two-method approach</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">setTitleAttribute</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">attributes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">&#39;title&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getTitleAttribute</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">strtoupper</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// New approach</span>
<span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">title</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name return-type">Attribute</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Attribute</span><span class="token punctuation">(</span>
        <span class="token argument-name">get</span><span class="token punctuation">:</span> <span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">strtoupper</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token argument-name">set</span><span class="token punctuation">:</span> <span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="保存模型及其所有关系" tabindex="-1"><a class="header-anchor" href="#保存模型及其所有关系" aria-hidden="true">#</a> 保存模型及其所有关系</h2><p>使用 <code>push()</code> 方法更新数据库中的主模型和相关模型。</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token doc-comment comment">/**
 * 使用 `push()` 将主模型与任何更改关系一起保存
 */</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">phone</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">has0ne</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;App\Models\Phone&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>User</span><span class="token operator">::</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;John&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">phone</span><span class="token operator">-&gt;</span><span class="token property">number</span> <span class="token operator">=</span> <span class="token string single-quoted-string">&#39;1234567890&#39;</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这会更新数据库中的用户记录和相关的用户电话号码记录</span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div></div><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="获取查询日志" tabindex="-1"><a class="header-anchor" href="#获取查询日志" aria-hidden="true">#</a> 获取查询日志</h2><p>在开发过程中记录所有数据库查询，请将此代码段添加到的 <code>AppServiceProvider.php</code>：</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name static-context">App</span><span class="token operator">::</span><span class="token function">environment</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;local&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name static-context">DB</span><span class="token operator">::</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">logger</span><span class="token punctuation">(</span><span class="token class-name static-context">Str</span><span class="token operator">::</span><span class="token function">replaceArray</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;?&#39;</span><span class="token punctuation">,</span> <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token property">bindings</span><span class="token punctuation">,</span> <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token property">sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="wherebelongsto-关联查询" tabindex="-1"><a class="header-anchor" href="#wherebelongsto-关联查询" aria-hidden="true">#</a> whereBelongsTo 关联查询</h2><p>在 <a href="https://github.com/laravel/framework/releases/tag/v8.63.0" target="_blank" rel="noopener noreferrer">laravel/framework v8.63.0<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 开始加入 <code>whereBelongsTo</code> 方法。</p><p>这允许从查询中删除已属性外键名称，并使用关系方法作为数据来源！</p><div class="language-php ext-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">// ❌</span>
<span class="token class-name static-context">Post</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;user_id&#39;</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">&#39;category_id&#39;</span><span class="token punctuation">,</span> <span class="token variable">$category</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ✅</span>
<span class="token class-name static-context">Post</span><span class="token operator">::</span><span class="token function">whereBelongsTo</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">whereBelongsTo</span><span class="token punctuation">(</span><span class="token variable">$category</span><span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: q.curder@gmail.com">curder</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/laravel-study/partials/blade.html" class="" aria-label="Blade 模版"><!--[--><!--]--> Blade 模版 <!--[--><!--]--></a></span><span class="next"><a href="/laravel-study/partials/routing.html" class="" aria-label="Routing 路由"><!--[--><!--]--> Routing 路由 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/laravel-study/assets/app.186c92d2.js" defer></script>
  </body>
</html>
